//
const carrdLinks = [
    // === KOLUMNA 1: EDYTORY I KOD ===
    // Row 1
    {
        id: "md-code",
        title: "MD CODE",
        url: "https://mdcode.carrd.co/",
        icon: "fas fa-file-code",
        iconClass: "icon-md",
        category: "code",
        subcategory: "markdown",
    },

    // Row 2
    {
        id: "edytor",
        title: "EDYTOR",
        url: "https://edytortxt.carrd.co/",
        icon: "fas fa-edit",
        iconClass: "icon-editor",
        category: "editors",
        subcategory: "text",
    },
    {
        id: "edytor-alt",
        title: "EDYTOR",
        url: "https://edytor.carrd.co/",
        icon: "fas fa-edit",
        iconClass: "icon-editor",
        category: "editors",
        subcategory: "text",
    },
    {
        id: "linkosi",
        title: "LINKOSI",
        url: "https://linkosi.carrd.co/",
        icon: "fas fa-file-alt",
        iconClass: "icon-text",
        category: "editors",
        subcategory: "links",
    },

    // Row 3
    {
        id: "playliveos",
        title: "PLAYLIVEOS",
        url: "https://playliveos.carrd.co/",
        icon: "fas fa-file-alt",
        iconClass: "icon-text",
        category: "editors",
        subcategory: "utility",
    },
    {
        id: "text-pro",
        title: "REACT LIVE",
        url: "https://reactlive.carrd.co/",
        icon: "fas fa-font",
        iconClass: "icon-text",
        category: "editors",
        subcategory: "text",
    },
    {
        id: "tools-nue",
        title: "TOOLS NUE",
        url: "https://toolsnue.carrd.co/",
        icon: "fas fa-wrench",
        iconClass: "icon-tools",
        category: "tools",
        subcategory: "utility",
    },

    // Row 2
    {
        id: "modifier",
        title: "MODIFIER",
        url: "https://modifier.carrd.co/",
        icon: "fas fa-sliders-h",
        iconClass: "icon-modifier",
        category: "tools",
        subcategory: "utility",
    },
    {
        id: "uniwersal-play",
        title: "UNIWERSAL PLAY",
        url: "https://uniwersalplay.carrd.co/",
        icon: "fas fa-play",
        iconClass: "icon-play",
        category: "tools",
        subcategory: "utility",
    },
    {
        id: "logowanie",
        title: "METEO",
        url: "https://appmeteo.carrd.co/",
        icon: "fas fa-sign-in-alt",
        iconClass: "icon-login",
        category: "tools",
        subcategory: "utility",
    },
    {
        id: "w5ui",
        title: "W5UI",
        url: "https://w5ui.carrd.co/",
        icon: "fas fa-palette",
        iconClass: "icon-w5ui",
        category: "tools",
        subcategory: "ui",
    },

    // === KOLUMNA 3: DANE, OBRAZY I WEB ===
    // Row 1
    {
        id: "arkusz",
        title: "ARKUSZ",
        url: "https://arkusz.carrd.co/",
        icon: "fas fa-table",
        iconClass: "icon-table",
        category: "data",
        subcategory: "spreadsheet",
    },
    {
        id: "sites-w5",
        title: "SITES W5",
        url: "https://sitesw5.carrd.co/",
        icon: "fas fa-globe",
        iconClass: "icon-sites",
        category: "tools",
        subcategory: "web",
    },
    {
        id: "project-dev",
        title: "VS EDITOR",
        url: "https://vseditor.carrd.co/",
        icon: "fas fa-project-diagram",
        iconClass: "icon-project",
        category: "tools",
        subcategory: "project",
    },

    // === DODATKOWE NARZDZIA ===
    // Row 4
    {
        id: "task-day",
        title: "EXD 9",
        url: "https://exd9.carrd.co/",
        icon: "fas fa-tasks",
        iconClass: "icon-task",
        category: "tools",
        subcategory: "tasks",
    },
    {
        id: "tools-link",
        title: "TOOLS LINK",
        url: "https://toolslinki.carrd.co/",
        icon: "fas fa-link",
        iconClass: "icon-link",
        category: "tools",
        subcategory: "links",
    },

    // Row 5
    {
        id: "tools-link-alt",
        title: "TOOLS LINK",
        url: "https://toolslink.carrd.co/",
        icon: "fas fa-link",
        iconClass: "icon-toolslink",
        category: "tools",
        subcategory: "links",
    },
];

const extraTools = [
    {
        id: "in-csv-dev",
        title: "Csv-3.1.F",
        url: "https://upcsv.carrd.co/",
        icon: "fas fa-file-csv",
        iconClass: "icon-csv",
        category: "data",
        subcategory: "csv",
    },
    {
        id: "web-tools-dev",
        title: "WEB TOOLS DEV",
        url: "https://webtoolsdev.carrd.co/",
        icon: "fas fa-globe",
        iconClass: "icon-web",
        category: "tools",
        subcategory: "web",
    },
    {
        id: "txt-pro",
        title: "TXT PRO",
        url: "https://txtpro.carrd.co",
        icon: "fas fa-font",
        iconClass: "icon-text",
        category: "editors",
        subcategory: "text",
    },
    {
        id: "text-img",
        title: "S-CSV-2.0.F",
        url: "https://incsvdev.carrd.co/",
        icon: "fas fa-table",
        iconClass: "icon-table",
        category: "tools",
        subcategory: "table",
    },
    {
        id: "addlist",
        title: "ADDLIST",
        url: "https://addlist.carrd.co/",
        icon: "fas fa-list-ol",
        iconClass: "icon-addlist",
        category: "tools",
        subcategory: "utility",
    },
    {
        id: "codeinspect",
        title: "CODEINSPECT",
        url: "https://codeinspect.carrd.co/",
        icon: "fas fa-search-plus",
        iconClass: "icon-codeinspect",
        category: "code",
        subcategory: "utility",
    },
    {
        id: "csvy",
        title: "CSVY",
        url: "https://csvy.carrd.co/",
        icon: "fas fa-file-csv",
        iconClass: "icon-csv",
        category: "data",
        subcategory: "csv",
    },
    {
        id: "czatdev",
        title: "CZATDEV",
        url: "https://czatdev.carrd.co/",
        icon: "fas fa-comments",
        iconClass: "icon-chat",
        category: "tools",
        subcategory: "chat",
    },
    {
        id: "devospanel",
        title: "DEVOSPANEL",
        url: "https://devospanel.carrd.co/",
        icon: "fas fa-columns",
        iconClass: "icon-panel",
        category: "tools",
        subcategory: "ui",
    },
    {
        id: "devpage5",
        title: "DEVPAGE5",
        url: "https://devpage5.carrd.co/",
        icon: "fas fa-file-alt",
        iconClass: "icon-page",
        category: "tools",
        subcategory: "web",
    },
    {
        id: "glassplay",
        title: "PLAY-PRO",
        url: "https://glassplay.carrd.co/",
        icon: "fas fa-play-circle",
        iconClass: "icon-play",
        category: "tools",
        subcategory: "media",
    },
    {
        id: "grafikdev",
        title: "GRAFIKDEV",
        url: "https://grafikdev.carrd.co/",
        icon: "fas fa-chart-pie",
        iconClass: "icon-graph",
        category: "data",
        subcategory: "charts",
    },
    {
        id: "grafiksum",
        title: "GRAFIKSUM",
        url: "https://grafiksum.carrd.co/",
        icon: "fas fa-chart-bar",
        iconClass: "icon-graph",
        category: "data",
        subcategory: "charts",
    },
    {
        id: "imgadd",
        title: "IMGADD",
        url: "https://imgadd.carrd.co/",
        icon: "fas fa-image",
        iconClass: "icon-image",
        category: "tools",
        subcategory: "image",
    },
    {
        id: "notedev",
        title: "NOTEDEV",
        url: "https://notedev.carrd.co/",
        icon: "fas fa-sticky-note",
        iconClass: "icon-note",
        category: "editors",
        subcategory: "notes",
    },
    {
        id: "panelsdev",
        title: "PANELSDEV",
        url: "https://panelsdev.carrd.co/",
        icon: "fas fa-grip-horizontal",
        iconClass: "icon-panel",
        category: "tools",
        subcategory: "ui",
    },
    {
        id: "playyt",
        title: "PLAYYT",
        url: "https://playyt.carrd.co/",
        icon: "fab fa-youtube",
        iconClass: "icon-youtube",
        category: "tools",
        subcategory: "media",
    },
    {
        id: "pracasuma",
        title: "PRACASUMA",
        url: "https://pracasuma.carrd.co/",
        icon: "fas fa-calculator",
        iconClass: "icon-calc",
        category: "tools",
        subcategory: "utility",
    },
    {
        id: "w5e",
        title: "W5E",
        url: "https://w5e.carrd.co/",
        icon: "fas fa-cubes",
        iconClass: "icon-w5e",
        category: "tools",
        subcategory: "ui",
    },
    {
        id: "previewgib",
        title: "previewgib",
        url: "https://previewgib.carrd.co/",
        icon: "fas fa-cubes",
        iconClass: "icon-w5e",
        category: "tools",
        subcategory: "ui",
    },
];

const cardData = [...carrdLinks, ...extraTools];

// Global variables
let editor;
let chat;

// --- MAIN INITIALIZATION ---
// Wait for dynamic HTML to be generated before initializing functionality
document.addEventListener("dynamicHTMLReady", () => {
    console.log("Dynamic HTML ready, initializing functionality...");
    initApiKey();
    initClockAndDate();
    initNavigation();
    initThemeToggle();
    initModals();
    renderAllCards();
    initMonacoEditor();
    initNotepadModal();
    initApiModal();
    initQuickLinksModal();
    initAddonsModal();
    initUiOptimizationModal();
    initCardGeneratorModal();
    initChatModal();
    initCodeGeneratorModal();
    initTranslatorModal();
    initTextAnalyzerModal();
    initIframeViewerModal();
    initCardIframeLinks();
    console.log("All functionality initialized successfully!");
});

// Fallback initialization for direct loading (if dynamic HTML is not used)
document.addEventListener("DOMContentLoaded", () => {
    // Check if dynamic HTML elements exist, if not wait a bit and try again
    if (
        !document.querySelector("nav") ||
        !document.querySelector(".content-container")
    ) {
        console.log("Waiting for dynamic HTML generation...");
        return; // Let the dynamicHTMLReady event handle initialization
    }

    // If static HTML exists, initialize immediately
    console.log("Static HTML detected, initializing immediately...");
    initApiKey();
    initClockAndDate();
    initNavigation();
    initThemeToggle();
    initModals();
    renderAllCards();
    initMonacoEditor();
    initNotepadModal();
    initApiModal();
    initQuickLinksModal();
    initAddonsModal();
    initUiOptimizationModal();
    initCardGeneratorModal();
    initChatModal();
    initCodeGeneratorModal();
    initTranslatorModal();
    initTextAnalyzerModal();
    initIframeViewerModal();
    initCardIframeLinks();
});

// --- UI INITIALIZATION FUNCTIONS ---

// --- API KEY MANAGEMENT ---
let ai = null;

function initApiKey() {
    console.log("Initializing API key functionality...");

    // Load saved API key
    const savedKey = localStorage.getItem("genai-api-key");
    if (savedKey) {
        document.getElementById("api-key-input").value = savedKey;
        initializeAI(savedKey);
    }

    // Set up event listeners
    document
        .getElementById("toggle-api-key")
        ?.addEventListener("click", toggleApiKeyVisibility);
    document
        .getElementById("save-api-key")
        ?.addEventListener("click", saveApiKey);
    document
        .getElementById("clear-api-key")
        ?.addEventListener("click", clearApiKey);
    document
        .getElementById("api-key-input")
        ?.addEventListener("input", handleApiKeyInput);
    document
        .getElementById("api-key-input")
        ?.addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
                saveApiKey();
            }
        });
}

function toggleApiKeyVisibility() {
    const input = document.getElementById("api-key-input");
    const icon = document.querySelector("#toggle-api-key i");

    if (input.type === "password") {
        input.type = "text";
        icon.classList.remove("fa-eye");
        icon.classList.add("fa-eye-slash");
    } else {
        input.type = "password";
        icon.classList.remove("fa-eye-slash");
        icon.classList.add("fa-eye");
    }
}

function handleApiKeyInput() {
    const input = document.getElementById("api-key-input");
    const status = document.getElementById("api-key-status");

    if (input.value.trim().length > 0) {
        status.innerHTML =
            '<i class="fas fa-info-circle"></i> Nacinij Enter lub Zapisz';
        status.className = "api-input-status warning visible";
    } else {
        status.innerHTML = "";
        status.className = "api-input-status";
    }
}

function saveApiKey() {
    const input = document.getElementById("api-key-input");
    const status = document.getElementById("api-key-status");
    const apiKey = input.value.trim();

    if (!apiKey) {
        status.innerHTML =
            '<i class="fas fa-exclamation-triangle"></i> Wprowad藕 klucz API';
        status.className = "api-input-status error visible";
        return;
    }

    // Save to localStorage
    localStorage.setItem("genai-api-key", apiKey);

    // Initialize AI
    initializeAI(apiKey);
}

function clearApiKey() {
    const input = document.getElementById("api-key-input");
    const status = document.getElementById("api-key-status");

    // Clear input
    input.value = "";

    // Clear localStorage
    localStorage.removeItem("genai-api-key");

    // Clear AI instance
    ai = null;

    // Update status
    status.innerHTML =
        '<i class="fas fa-info-circle"></i> Klucz API zosta wyczyszczony';
    status.className = "api-input-status warning visible";

    // Clear status after 3 seconds
    setTimeout(() => {
        status.innerHTML = "";
        status.className = "api-input-status";
    }, 3000);

    console.log("API key cleared");
}

async function initializeAI(apiKey) {
    const status = document.getElementById("api-key-status");

    try {
        status.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> Sprawdzanie klucza...';
        status.className = "api-input-status warning visible";

        // Import and initialize Google GenAI
        const { GoogleGenerativeAI } = await import("@google/genai");
        ai = new GoogleGenerativeAI(apiKey);

        // Test the API key with a simple request
        const model = ai.getGenerativeModel({ model: "gemini-1.5-flash" });
        await model.generateContent("Test");

        status.innerHTML =
            '<i class="fas fa-check-circle"></i> Klucz API sprawny';
        status.className = "api-input-status success visible";

        console.log("AI initialized successfully");
    } catch (error) {
        console.error("AI initialization failed:", error);
        status.innerHTML =
            '<i class="fas fa-exclamation-triangle"></i> Nieprawidowy klucz API';
        status.className = "api-input-status error visible";
        ai = null;
    }
}

function initClockAndDate() {
    const hoursEl = document.getElementById("hours");
    const minutesEl = document.getElementById("minutes");
    const secondsEl = document.getElementById("seconds");
    const dateEl = document.getElementById("current-date");

    function updateTime() {
        const now = new Date();
        hoursEl.textContent = String(now.getHours()).padStart(2, "0");
        minutesEl.textContent = String(now.getMinutes()).padStart(2, "0");
        secondsEl.textContent = String(now.getSeconds()).padStart(2, "0");
    }

    function updateDate() {
        const now = new Date();
        const options = {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
        };
        dateEl.textContent = now
            .toLocaleDateString("pl-PL", options)
            .toUpperCase();
    }

    updateTime();
    updateDate();
    setInterval(updateTime, 1000);
}

function initNavigation() {
    const navButtons = document.querySelectorAll(".nav-button");
    const contentSections = document.querySelectorAll(".content-section");

    navButtons.forEach((button) => {
        button.addEventListener("click", () => {
            const targetId = button.getAttribute("data-target");

            navButtons.forEach((btn) => btn.classList.remove("active"));
            button.classList.add("active");

            contentSections.forEach((section) => {
                section.classList.remove("active");
                if (section.id === targetId) {
                    section.classList.add("active");
                }
            });
        });
    });
}

// Theme toggle is now handled by index.html - this function is no longer needed

function initModals() {
    const modals = document.querySelectorAll(".modal");
    const apiModal = document.getElementById("myModal10");

    // Open modal
    for (let i = 1; i <= 10; i++) {
        const openButton = document.getElementById(`openModal${i}`);
        if (openButton) {
            openButton.addEventListener("click", () => {
                if (i === 10) {
                    // Special handling for API modal
                    apiModal?.classList.add("active");
                } else {
                    document
                        .getElementById(`myModal${i}`)
                        ?.classList.add("active");
                }
            });
        }
    }

    // Close modal
    modals.forEach((modal) => {
        modal.addEventListener("click", (e) => {
            if (
                e.target === modal ||
                e.target.classList.contains("close-button")
            ) {
                modal.classList.remove("active");
                // If we are closing the iframe modal, reset its content
                if (modal.id === "myModal9") {
                    const iframe = document.getElementById("content-iframe");
                    if (iframe) {
                        iframe.src = "about:blank";
                    }
                }
            }
        });
    });

    // Special handling for API modal
    if (apiModal) {
        // Close on overlay click
        const overlay = apiModal.querySelector(".modal-api-overlay");
        if (overlay) {
            overlay.addEventListener("click", () => {
                apiModal.classList.remove("active");
            });
        }

        // Close on close button click
        const closeBtn = document.getElementById("close-api-modal");
        if (closeBtn) {
            closeBtn.addEventListener("click", () => {
                apiModal.classList.remove("active");
            });
        }
    }
}

// === LOGIKA FAVICON (PRZENIESIONA Z INDEX.HTML) ===

/**
 * Pobiera preferowany URL favicony.
 * @param {string} url - Peny URL linku.
 * @returns {string} - URL do pr贸by pobrania favicony.
 */
function getFaviconUrl(url) {
    let cleanUrl;
    try {
        cleanUrl = new URL(url).hostname.replace(/^www\./, "");
    } catch (e) {
        cleanUrl = url
            .replace(/^https?:\/\//, "")
            .replace(/^www\./, "")
            .split("/")[0];
    }

    // Dla carrd.co u偶yj prawdziw struktur favicon
    if (cleanUrl.includes("carrd.co")) {
        return `https://${cleanUrl}/assets/images/favicon.png`;
    }

    return `https://t0.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url=https://${cleanUrl}&size=32`;
}

/**
 * Obsuguje bdy adowania favicon, pr贸bujc r贸偶nych 藕r贸de.
 * @param {HTMLElement} imgElement - Element <img>, kt贸ry zawi贸d.
 * @param {string} linkUrl - URL linku.
 */
function handleFaviconError(imgElement, linkUrl) {
    const attempt = parseInt(imgElement.dataset.attempt) || 1;
    let cleanUrl;
    try {
        cleanUrl = new URL(linkUrl).hostname.replace(/^www\./, "");
    } catch (e) {
        cleanUrl = linkUrl
            .replace(/^https?:\/\//, "")
            .replace(/^www\./, "")
            .split("/")[0];
    }
    const isCarrd = cleanUrl.includes("carrd.co");

    if (isCarrd) {
        // Specjalna logika dla carrd.co
        if (attempt === 1) {
            // Druga pr贸ba - apple-touch-icon jako fallback
            imgElement.src = `https://${cleanUrl}/assets/images/apple-touch-icon.png`;
            imgElement.dataset.attempt = "2";
        } else if (attempt === 2) {
            // Trzecia pr贸ba - Yandex API
            imgElement.src = `https://favicon.yandex.net/favicon/${cleanUrl}`;
            imgElement.dataset.attempt = "3";
        } else {
            // Poka偶 fallback
            showFaviconFallback(imgElement, linkUrl);
        }
    } else {
        // Standardowa logika dla innych stron
        if (attempt === 1) {
            // Druga pr贸ba - stare Google Favicons API jako fallback
            imgElement.src = `https://www.google.com/s2/favicons?domain=${cleanUrl}&sz=32`;
            imgElement.dataset.attempt = "2";
        } else if (attempt === 2) {
            // Trzecia pr贸ba - DuckDuckGo
            imgElement.src = `https://icons.duckduckgo.com/ip3/${cleanUrl}.ico`;
            imgElement.dataset.attempt = "3";
        } else if (attempt === 3) {
            // Czwarta pr贸ba - bezporedni favicon
            imgElement.src = `https://${cleanUrl}/favicon.ico`;
            imgElement.dataset.attempt = "4";
        } else {
            // Poka偶 fallback
            showFaviconFallback(imgElement, linkUrl);
        }
    }
}

/**
 * Wywietla rezerwow ikon (liter) w przypadku niepowodzenia adowania favicony.
 * @param {HTMLElement} imgElement - Element <img>, kt贸ry zawi贸d.
 */
function showFaviconFallback(imgElement) {
    imgElement.style.display = "none"; // Ukryj uszkodzony obraz
    const fallbackDiv = imgElement.nextElementSibling; // Znajd藕 fallback div
    if (
        fallbackDiv &&
        (fallbackDiv.classList.contains("favicon-fallback") ||
            fallbackDiv.classList.contains("card-icon-fallback"))
    ) {
        fallbackDiv.style.display = "flex"; // Poka偶 fallback
    }
}

/**
 * Pobiera pierwsz liter domeny dla fallbacku.
 * @param {string} linkUrl - URL linku.
 * @returns {string} - Pierwsza litera domeny.
 */
function getFirstLetter(linkUrl) {
    try {
        const domain = new URL(linkUrl).hostname.replace(/^www\./, "");
        return domain.charAt(0).toUpperCase();
    } catch (e) {
        try {
            const domain = linkUrl
                .replace(/^https?:\/\//, "")
                .replace(/^www\./, "");
            return domain.charAt(0).toUpperCase();
        } catch (e2) {
            return "?";
        }
    }
}

// === KONIEC LOGIKI FAVICON ===

function renderAllCards() {
    const allGrid = document.getElementById("all-grid");
    const editorsGrid = document.getElementById("editors-grid");
    const toolsGrid = document.getElementById("tools-grid");
    const dataGrid = document.getElementById("data-grid");
    const codeGrid = document.getElementById("code-grid");

    const grids = {
        editors: editorsGrid,
        tools: toolsGrid,
        data: dataGrid,
        code: codeGrid,
    };

    const container = document.querySelector("#all-section .grid-container");
    container.innerHTML = "";

    Object.values(grids).forEach((grid) => {
        if (grid) grid.innerHTML = "";
    });

    cardData.forEach((card) => {
        // *** MODYFIKACJA ***
        // Dodano logik favicon
        const faviconUrl = getFaviconUrl(card.url);
        const fallbackLetter = getFirstLetter(card.url);
        const escapedUrl = card.url
            .replace(/'/g, "\\'")
            .replace(/"/g, "&quot;");

        // Zastpiono <i class="..."></i> now logik <img> + fallback
        const cardHtml = `
            <div class="card" data-category="${card.category}">
                
                <!-- Ikona (favicon) -->
                <img src="${faviconUrl}" 
                     alt="${card.title} icon" 
                     class="card-icon" 
                     loading="lazy"
                     data-attempt="1"
                     onerror="handleFaviconError(this, '${escapedUrl}')"
                >
                
                <!-- Fallback na liter -->
                <div class="card-icon-fallback" style="display: none;">
                    ${fallbackLetter}
                </div>

                <h3>${card.title}</h3>
                <p>${
                    card.subcategory.charAt(0).toUpperCase() +
                    card.subcategory.slice(1)
                }</p>
                <div class="card-buttons">
                    <a href="${
                        card.url
                    }" class="card-iframe-link" rel="noopener noreferrer"><i class="fas fa-eye"></i></a>
                    <a href="${
                        card.url
                    }" class="card-new-tab-link" target="_blank" rel="noopener noreferrer"><i class="fas fa-plus"></i></a>
                </div>
            </div>
        `;
        // *** KONIEC MODYFIKACJI ***

        container.innerHTML += cardHtml;
        if (grids[card.category]) {
            grids[card.category].innerHTML += cardHtml;
        }
    });
}

function initMonacoEditor() {
    // ... (reszta kodu bez zmian) ...
    // Dispose of existing editors if they exist
    if (window.editor) {
        console.log("Disposing existing Monaco editor...");
        window.editor.dispose();
        window.editor = null;
    }

    if (window.fullscreenEditor) {
        console.log("Disposing existing fullscreen Monaco editor...");
        window.fullscreenEditor.dispose();
        window.fullscreenEditor = null;
    }

    const container = document.getElementById("monaco-editor-container");
    const fullscreenContainer = document.getElementById(
        "monaco-editor-fullscreen"
    );

    if (!container) {
        console.error("Monaco editor container not found");
        return;
    }

    // Clear the container content
    container.innerHTML = "";
    if (fullscreenContainer) {
        fullscreenContainer.innerHTML = "";
    }

    window.require.config({
        paths: {
            vs: "https://cdn.jsdelivr.net/npm/monaco-editor@0.49.0/min/vs",
        },
    });
    window.require(["vs/editor/editor.main"], () => {
        try {
            console.log("Creating Monaco editor...");

            // Get initial settings
            const initialLanguage =
                document.getElementById("language-select")?.value ||
                "javascript";
            const initialTheme =
                document.getElementById("theme-select")?.value || "vs-dark";
            const initialFontSize = parseInt(
                document.getElementById("font-size-select")?.value || "14"
            );

            // Enhanced editor configuration
            const editorConfig = {
                value: `// Witaj w rozszerzonym edytorze Monaco AI!
// Wybierz jzyk programowania z g贸rnego menu
// U偶yj Ctrl+Shift+P aby otworzy palet polece

console.log("Hello, World!");`,
                language: initialLanguage,
                theme: initialTheme,
                automaticLayout: true,
                fontSize: initialFontSize,
                fontFamily:
                    'Fira Code, Cascadia Code, Monaco, "Courier New", monospace',
                fontLigatures: true,
                lineNumbers: "on",
                rulers: [80, 120],
                wordWrap: "off",
                minimap: { enabled: true },
                scrollBeyondLastLine: false,
                smoothScrolling: true,
                cursorBlinking: "blink",
                cursorSmoothCaretAnimation: true,
                contextmenu: true,
                folding: true,
                foldingStrategy: "indentation",
                showFoldingControls: "always",
                bracketPairColorization: { enabled: true },
                guides: {
                    bracketPairs: true,
                    indentation: true,
                },
                suggest: {
                    showKeywords: true,
                    showSnippets: true,
                },
                quickSuggestions: {
                    other: true,
                    comments: true,
                    strings: true,
                },
            };

            // Create main editor
            window.editor = monaco.editor.create(container, editorConfig);

            // Create fullscreen editor with same config
            if (fullscreenContainer) {
                window.fullscreenEditor = monaco.editor.create(
                    fullscreenContainer,
                    {
                        ...editorConfig,
                        value: "",
                    }
                );
            }

            console.log("Monaco editor created successfully");

            // Initialize editor controls and event listeners
            initEditorControls();
            initEditorEventListeners();
            updateEditorStatus();
            loadNotes();
        } catch (error) {
            console.error("Error creating Monaco editor:", error);
        }
    });
}

// Initialize editor controls and event handlers
function initEditorControls() {
    const languageSelect = document.getElementById("language-select");
    const encodingSelect = document.getElementById("encoding-select");
    const themeSelect = document.getElementById("theme-select");
    const fontSizeSelect = document.getElementById("font-size-select");

    const fullscreenToggle = document.getElementById("fullscreen-toggle");
    const wordWrapToggle = document.getElementById("word-wrap-toggle");
    const minimapToggle = document.getElementById("minimap-toggle");
    const formatCode = document.getElementById("format-code");
    const exitFullscreen = document.getElementById("exit-fullscreen");

    // Language change handler
    languageSelect?.addEventListener("change", (e) => {
        const language = e.target.value;
        if (window.editor) {
            const model = window.editor.getModel();
            monaco.editor.setModelLanguage(model, language);
        }
        if (window.fullscreenEditor) {
            const model = window.fullscreenEditor.getModel();
            monaco.editor.setModelLanguage(model, language);
        }
        updateEditorStatus();
    });

    // Encoding change handler (visual feedback)
    encodingSelect?.addEventListener("change", (e) => {
        const encoding = e.target.value;
        document.getElementById("editor-encoding").textContent =
            encoding.toUpperCase();
        showNotification(`Zmieniono kodowanie na: ${encoding.toUpperCase()}`);
    });

    // Theme change handler
    themeSelect?.addEventListener("change", (e) => {
        const theme = e.target.value;
        monaco.editor.setTheme(theme);
    });

    // Font size change handler
    fontSizeSelect?.addEventListener("change", (e) => {
        const fontSize = parseInt(e.target.value);
        if (window.editor) {
            window.editor.updateOptions({ fontSize: fontSize });
        }
        if (window.fullscreenEditor) {
            window.fullscreenEditor.updateOptions({ fontSize: fontSize });
        }
    });

    // Fullscreen toggle
    fullscreenToggle?.addEventListener("click", () => {
        toggleFullscreenEditor();
    });

    // Word wrap toggle
    wordWrapToggle?.addEventListener("click", (e) => {
        const currentWrap = window.editor.getOption(
            monaco.editor.EditorOption.wordWrap
        );
        const newWrap = currentWrap === "off" ? "on" : "off";

        if (window.editor) {
            window.editor.updateOptions({ wordWrap: newWrap });
        }
        if (window.fullscreenEditor) {
            window.fullscreenEditor.updateOptions({ wordWrap: newWrap });
        }

        e.target.classList.toggle("active", newWrap === "on");
        showNotification(
            `Zawijanie wierszy: ${newWrap === "on" ? "wczone" : "wyczone"}`
        );
    });

    // Minimap toggle
    minimapToggle?.addEventListener("click", (e) => {
        const currentMinimap = window.editor.getOption(
            monaco.editor.EditorOption.minimap
        );
        const newMinimapEnabled = !currentMinimap.enabled;

        if (window.editor) {
            window.editor.updateOptions({
                minimap: { enabled: newMinimapEnabled },
            });
        }
        if (window.fullscreenEditor) {
            window.fullscreenEditor.updateOptions({
                minimap: { enabled: newMinimapEnabled },
            });
        }

        e.target.classList.toggle("active", newMinimapEnabled);
        showNotification(
            `Minimapa: ${newMinimapEnabled ? "wczona" : "wyczona"}`
        );
    });

    // Format code
    formatCode?.addEventListener("click", () => {
        if (window.editor) {
            window.editor.getAction("editor.action.formatDocument").run();
        }
        showNotification("Kod zosta sformatowany");
    });

    // Exit fullscreen
    exitFullscreen?.addEventListener("click", () => {
        console.log("Exit fullscreen button clicked");
        toggleFullscreenEditor();
    });

    // Close fullscreen modal when clicking outside
    const fullscreenModal = document.getElementById("editor-fullscreen-modal");
    fullscreenModal?.addEventListener("click", (e) => {
        if (e.target === fullscreenModal) {
            console.log("Clicked outside fullscreen modal");
            toggleFullscreenEditor();
        }
    });
}

// Initialize editor event listeners for status updates
function initEditorEventListeners() {
    if (!window.editor) return;

    // Cursor position change
    window.editor.onDidChangeCursorPosition((e) => {
        updateEditorStatus();
    });

    // Content change
    window.editor.onDidChangeModelContent((e) => {
        updateEditorStatus();
        // Sync with fullscreen editor when not in fullscreen mode
        if (window.fullscreenEditor && !isFullscreenMode()) {
            window.fullscreenEditor.setValue(window.editor.getValue());
        }
    });

    // Focus/blur events for better UX
    window.editor.onDidFocusEditorText(() => {
        const container = document.getElementById("monaco-editor-container");
        if (container) container.style.borderColor = "var(--accent-color)";
    });

    window.editor.onDidBlurEditorText(() => {
        const container = document.getElementById("monaco-editor-container");
        if (container) container.style.borderColor = "var(--border-color)";
    });

    // Add keyboard shortcuts
    window.addEventListener("keydown", handleEditorKeyboard);
}

// Handle keyboard shortcuts for editor
function handleEditorKeyboard(e) {
    // Only handle if we have focus on editor or modal
    const modal = document.getElementById("myModal1");
    if (!modal?.classList.contains("active")) return;

    // F11 - Toggle fullscreen
    if (e.key === "F11") {
        e.preventDefault();
        toggleFullscreenEditor();
        return;
    }

    // Escape - Exit fullscreen if in fullscreen mode
    if (e.key === "Escape" && isFullscreenMode()) {
        e.preventDefault();
        toggleFullscreenEditor();
        return;
    }

    // Ctrl+S - Save note
    if (e.ctrlKey && e.key === "s") {
        e.preventDefault();
        saveNote();
        return;
    }

    // Ctrl+Shift+F - Format code
    if (e.ctrlKey && e.shiftKey && e.key === "F") {
        e.preventDefault();
        if (window.editor) {
            window.editor.getAction("editor.action.formatDocument").run();
            showNotification("Kod zosta sformatowany");
        }
        return;
    }

    // Alt+W - Toggle word wrap
    if (e.altKey && e.key === "w") {
        e.preventDefault();
        const wordWrapToggle = document.getElementById("word-wrap-toggle");
        if (wordWrapToggle) {
            wordWrapToggle.click();
        }
        return;
    }

    // Alt+M - Toggle minimap
    if (e.altKey && e.key === "m") {
        e.preventDefault();
        const minimapToggle = document.getElementById("minimap-toggle");
        if (minimapToggle) {
            minimapToggle.click();
        }
        return;
    }
}

// Update editor status bar
function updateEditorStatus() {
    if (!window.editor) return;

    const position = window.editor.getPosition();
    const model = window.editor.getModel();
    const language = model.getLanguageId();
    const lineCount = model.getLineCount();
    const encoding =
        document.getElementById("encoding-select")?.value || "utf-8";

    document.getElementById(
        "cursor-position"
    ).textContent = `Ln ${position.lineNumber}, Col ${position.column} (${lineCount} lines)`;
    document.getElementById("editor-language").textContent =
        language.toUpperCase();
    document.getElementById("editor-encoding").textContent =
        encoding.toUpperCase();
}

// Toggle fullscreen editor mode
function toggleFullscreenEditor() {
    const fullscreenModal = document.getElementById("editor-fullscreen-modal");
    const exitButton = document.getElementById("exit-fullscreen");
    const fullscreenContainer = document.getElementById(
        "monaco-editor-fullscreen"
    );

    console.log(" toggleFullscreenEditor called");
    console.log(" fullscreenModal:", fullscreenModal);
    console.log(" exitButton:", exitButton);
    console.log(" fullscreenContainer:", fullscreenContainer);
    console.log(" window.fullscreenEditor:", window.fullscreenEditor);
    console.log(" window.editor:", window.editor);

    if (!fullscreenModal) {
        console.error("Fullscreen modal not found");
        return;
    }

    if (isFullscreenMode()) {
        console.log("Exiting fullscreen mode");
        // Exit fullscreen
        fullscreenModal.classList.remove("active");

        // Sync back to main editor
        if (window.editor && window.fullscreenEditor) {
            window.editor.setValue(window.fullscreenEditor.getValue());
            window.editor.focus();
        }
        showNotification("Wyszede z trybu penoekranowego");
    } else {
        console.log("Entering fullscreen mode");
        // Enter fullscreen
        if (window.fullscreenEditor && window.editor) {
            window.fullscreenEditor.setValue(window.editor.getValue());
            fullscreenModal.classList.add("active");

            // Ensure exit button is visible and properly styled
            if (exitButton) {
                exitButton.style.display = "flex";
                exitButton.style.visibility = "visible";
                exitButton.style.opacity = "1";
                exitButton.style.zIndex = "10001";
                console.log("Exit button made visible");
            }

            // Focus fullscreen editor after animation
            setTimeout(() => {
                window.fullscreenEditor.focus();
                window.fullscreenEditor.layout();
            }, 300);

            showNotification(
                "Tryb penoekranowy aktywny - nacinij Escape lub przycisk Zamknij aby wyj"
            );
        } else {
            console.error("Fullscreen editor not initialized properly");
        }
    }
}

// Check if in fullscreen mode
function isFullscreenMode() {
    const fullscreenModal = document.getElementById("editor-fullscreen-modal");
    return fullscreenModal?.classList.contains("active") || false;
}

// Show notification helper
function showNotification(message) {
    // Create a simple notification
    const notification = document.createElement("div");
    notification.className = "editor-notification";
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--accent-color);
        color: var(--bg-primary);
        padding: 8px 16px;
        border-radius: 4px;
        font-size: 12px;
        z-index: 10001;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
    `;

    document.body.appendChild(notification);

    // Animate in
    setTimeout(() => {
        notification.style.opacity = "1";
        notification.style.transform = "translateX(0)";
    }, 10);

    // Remove after 3 seconds
    setTimeout(() => {
        notification.style.opacity = "0";
        notification.style.transform = "translateX(100%)";
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}

// --- GEMINI API HELPERS ---

async function runAi(
    prompt,
    modelElementId,
    loadingElementId,
    outputElementId,
    systemInstruction,
    maxRetries = 3
) {
    const modelSelect = document.getElementById(modelElementId);
    const loadingIndicator = document.getElementById(loadingElementId);
    const outputElement = document.getElementById(outputElementId);

    if (!modelSelect || !loadingIndicator || !outputElement) return;

    // Check if AI is initialized
    if (!ai) {
        showErrorModal(
            "Bd AI",
            "Klucz API nie zosta skonfigurowany. Wprowad藕 prawidowy klucz API Google GenAI.",
            "Przejd藕 do pola klucza API w g贸rnej czci strony."
        );
        return;
    }

    // Enhanced loading indicator
    loadingIndicator.style.display = "block";
    loadingIndicator.innerHTML =
        '<i class="fas fa-spinner fa-spin"></i> Generowanie odpowiedzi AI...';
    outputElement.innerHTML = "";

    let attempt = 0;

    while (attempt < maxRetries) {
        try {
            attempt++;

            // Update loading message for retries
            if (attempt > 1) {
                loadingIndicator.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Pr贸ba ${attempt}/${maxRetries}...`;
            }

            // Timeout promise
            const timeoutPromise = new Promise((_, reject) => {
                setTimeout(
                    () =>
                        reject(
                            new Error("Timeout - zapytanie trwao zbyt dugo")
                        ),
                    30000
                );
            });

            // Get the model
            const model = ai.getGenerativeModel({ model: modelSelect.value });

            // AI request promise
            const aiPromise = model.generateContent({
                contents: [
                    {
                        role: "user",
                        parts: [
                            {
                                text: systemInstruction
                                    ? `${systemInstruction}\n\n${prompt}`
                                    : prompt,
                            },
                        ],
                    },
                ],
                generationConfig: {
                    temperature: 0.7,
                    topK: 40,
                    topP: 0.95,
                    maxOutputTokens: 8192,
                },
            });

            // Race between timeout and AI response
            const response = await Promise.race([aiPromise, timeoutPromise]);

            // Success - format and display response
            const responseText = response.response.text();
            const formattedText = responseText
                .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
                .replace(/\*(.*?)\*/g, "<em>$1</em>")
                .replace(
                    /```(\w*)\n([\s\S]*?)```/g,
                    '<pre><code class="language-$1">$2</code></pre>'
                )
                .replace(/\n/g, "<br>");

            outputElement.innerHTML = formattedText;

            // Apply syntax highlighting if code blocks exist
            const codeBlocks = outputElement.querySelectorAll("pre code");
            codeBlocks.forEach((block) => {
                // Simple syntax highlighting for common languages
                highlightCode(block);
            });

            break; // Success, break out of retry loop
        } catch (error) {
            console.error(`AI Error (attempt ${attempt}):`, error);

            if (attempt >= maxRetries) {
                // All retries exhausted
                let errorMessage =
                    "Wystpi bd podczas generowania odpowiedzi AI.";

                if (error.message.includes("Timeout")) {
                    errorMessage =
                        "Zapytanie przekroczyo limit czasu. Spr贸buj ponownie z kr贸tszym promptem.";
                } else if (error.message.includes("quota")) {
                    errorMessage =
                        "Osignito limit API. Spr贸buj ponownie p贸藕niej.";
                } else if (error.message.includes("safety")) {
                    errorMessage =
                        "Tre zostaa zablokowana ze wzgld贸w bezpieczestwa. Spr贸buj przeformuowa zapytanie.";
                }

                // Show error modal instead of inline error
                showErrorModal(
                    "Bd AI",
                    errorMessage,
                    `Szczeg贸y: ${error.message}`
                );
            } else {
                // Wait before retry
                await new Promise((resolve) =>
                    setTimeout(resolve, 1000 * attempt)
                );
            }
        }
    }

    loadingIndicator.style.display = "none";
}

// Simple syntax highlighting function
function highlightCode(codeElement) {
    const code = codeElement.textContent;
    const language =
        codeElement.className.replace("language-", "") || "javascript";

    let highlightedCode = code;

    // Basic syntax highlighting patterns
    const patterns = {
        javascript: [
            {
                regex: /\b(function|const|let|var|if|else|for|while|return|import|export|class|extends)\b/g,
                class: "keyword",
            },
            { regex: /"([^"\\]|\\.)*"/g, class: "string" },
            { regex: /'([^'\\]|\\.)*'/g, class: "string" },
            { regex: /\/\/.*$/gm, class: "comment" },
            { regex: /\/\*[\s\S]*?\*\//g, class: "comment" },
        ],
        python: [
            {
                regex: /\b(def|class|if|elif|else|for|while|import|from|return|try|except|with|as)\b/g,
                class: "keyword",
            },
            { regex: /"([^"\\]|\\.)*"/g, class: "string" },
            { regex: /'([^'\\]|\\.)*'/g, class: "string" },
            { regex: /#.*$/gm, class: "comment" },
        ],
        html: [
            { regex: /<\/?[\w\s="/.':;#-\/\?]+>/g, class: "tag" },
            { regex: /<!--[\s\S]*?-->/g, class: "comment" },
        ],
    };

    if (patterns[language]) {
        patterns[language].forEach((pattern) => {
            highlightedCode = highlightedCode.replace(
                pattern.regex,
                `<span class="highlight-${pattern.class}">$&</span>`
            );
        });
        codeElement.innerHTML = highlightedCode;
    }
}

function parseJsonFromMarkdown(text) {
    const fenceRegex = /^```(\w*)?\s*\n?(.*?)\n?\s*```$/s;
    const match = text.match(fenceRegex);
    let jsonStr = text.trim();
    if (match && match[2]) {
        jsonStr = match[2].trim();
    }
    try {
        return JSON.parse(jsonStr);
    } catch (e) {
        console.error("Failed to parse JSON response:", e);
        throw new Error(
            "Nie udao si przetworzy odpowiedzi AI. Odpowied藕 nie bya w formacie JSON."
        );
    }
}

// --- MODAL-SPECIFIC FUNCTIONALITY ---

function initNotepadModal() {
    document
        .getElementById("save-note-button")
        ?.addEventListener("click", saveNote);
    document
        .getElementById("summarize-note-button")
        ?.addEventListener("click", () => {
            const content = getCurrentEditorContent();
            if (!content.trim()) {
                showErrorModal(
                    "Bd",
                    "Edytor jest pusty. Napisz co, aby to podsumowa."
                );
                return;
            }
            runAi(
                content,
                "ai-model-select-1",
                "loading-indicator-1",
                "translation-output",
                "Podsumuj ten tekst w kilku kluczowych punktach."
            );
        });
    document
        .getElementById("expand-note-button")
        ?.addEventListener("click", () => {
            const content = getCurrentEditorContent();
            if (!content.trim()) {
                showErrorModal(
                    "Bd",
                    "Edytor jest pusty. Napisz co, aby to rozwin."
                );
                return;
            }
            runAi(
                content,
                "ai-model-select-1",
                "loading-indicator-1",
                "translation-output",
                "Rozwi ten temat, dodajc wicej szczeg贸贸w i kontekstu."
            );
        });
    document
        .getElementById("translate-note-button")
        ?.addEventListener("click", () => {
            const content = getCurrentEditorContent();
            if (!content.trim()) {
                showErrorModal(
                    "Bd",
                    "Edytor jest pusty. Napisz co, aby to przetumaczy."
                );
                return;
            }
            const lang = document.getElementById(
                "translation-language-select"
            ).value;
            runAi(
                content,
                "ai-model-select-1",
                "loading-indicator-1",
                "translation-output",
                `Przetumacz ten tekst na jzyk ${lang}.`
            );
        });
}

function initApiModal() {
    console.log("Initializing API modal...");
    // API modal initialization is handled by initApiKey() function
    // This function is here for consistency with other modal initializations
}

// Helper function to get content from current active editor
function getCurrentEditorContent() {
    if (isFullscreenMode() && window.fullscreenEditor) {
        return window.fullscreenEditor.getValue();
    } else if (window.editor) {
        return window.editor.getValue();
    }
    return "";
}

// Helper function to set content in current active editor
function setCurrentEditorContent(content) {
    if (isFullscreenMode() && window.fullscreenEditor) {
        window.fullscreenEditor.setValue(content);
    } else if (window.editor) {
        window.editor.setValue(content);
    }
}

function saveNote() {
    const content = getCurrentEditorContent();
    if (!content.trim()) {
        showErrorModal("Bd", "Nie mo偶na zapisa pustej notatki.");
        return;
    }
    const notes = JSON.parse(localStorage.getItem("notes") || "[]");
    const noteTitle = content.split("\n")[0].substring(0, 40) || "Nowa notatka";
    const timestamp = new Date().toLocaleString("pl-PL");
    notes.push({
        title: noteTitle,
        content: content,
        id: Date.now(),
        timestamp: timestamp,
        language:
            document.getElementById("language-select")?.value || "javascript",
    });
    localStorage.setItem("notes", JSON.stringify(notes));
    loadNotes();
    showNotification(`Notatka "${noteTitle}" zostaa zapisana`);
}

function loadNotes() {
    const notes = JSON.parse(localStorage.getItem("notes") || "[]");
    const listEl = document.getElementById("saved-notes-list");

    if (!listEl) return;

    listEl.innerHTML = "";

    if (notes.length === 0) {
        listEl.innerHTML =
            '<div style="text-align: center; color: var(--text-muted); padding: var(--spacing-md); font-size: 12px;">锔<br>Brak zapisanych notatek</div>';
        return;
    }

    // Sort notes by timestamp (newest first)
    notes.sort((a, b) => b.id - a.id);

    notes.forEach((note) => {
        const item = document.createElement("div");
        item.className = "saved-note-item";

        const noteHeader = document.createElement("div");
        noteHeader.className = "note-header";
        noteHeader.innerHTML = `
            <div class="note-title">${note.title}</div>
            <div class="note-meta">
                <span class="note-language">${(
                    note.language || "javascript"
                ).toUpperCase()}</span>
                ${
                    note.timestamp
                        ? `<span class="note-timestamp">${note.timestamp}</span>`
                        : ""
                }
            </div>
        `;

        const actions = document.createElement("div");
        actions.className = "note-actions";

        const loadBtn = document.createElement("button");
        loadBtn.innerHTML = '<i class="fas fa-file-import"></i>';
        loadBtn.className = "load-note-btn";
        loadBtn.title = "Zaaduj notatk";
        loadBtn.onclick = (e) => {
            e.stopPropagation();
            loadNoteContent(note);
        };

        const deleteBtn = document.createElement("button");
        deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
        deleteBtn.className = "delete-note-btn";
        deleteBtn.title = "Usu notatk";
        deleteBtn.onclick = (e) => {
            e.stopPropagation();
            deleteNote(note.id);
        };

        actions.appendChild(loadBtn);
        actions.appendChild(deleteBtn);

        item.appendChild(noteHeader);
        item.appendChild(actions);

        // Click on item to load note
        item.onclick = () => loadNoteContent(note);

        listEl.appendChild(item);
    });
}

// Load note content and set language
function loadNoteContent(note) {
    setCurrentEditorContent(note.content);

    // Set language if available
    if (note.language) {
        const languageSelect = document.getElementById("language-select");
        if (languageSelect) {
            languageSelect.value = note.language;
            // Trigger change event to update editor
            languageSelect.dispatchEvent(new Event("change"));
        }
    }

    showNotification(`Zaadowano notatk: ${note.title}`);
}

function deleteNote(id) {
    let notes = JSON.parse(localStorage.getItem("notes") || "[]");
    notes = notes.filter((note) => note.id !== id);
    localStorage.setItem("notes", JSON.stringify(notes));
    loadNotes();
}

async function initQuickLinksModal() {
    document
        .getElementById("suggest-links-button")
        ?.addEventListener("click", async () => {
            const input = document.getElementById(
                "link-suggestion-input"
            ).value;
            const loadingIndicator = document.getElementById(
                "loading-indicator-2"
            );
            const outputElement = document.getElementById(
                "suggested-links-output"
            );

            const prompt = `Zasugeruj 5 przydatnych link贸w na temat "${input}". Zwr贸 jako tablic obiekt贸w JSON z kluczami "title" i "url".`;

            loadingIndicator.style.display = "block";
            outputElement.innerHTML = "";

            try {
                const response = await ai.models.generateContent({
                    model: "gemini-2.5-flash-preview-04-17",
                    contents: prompt,
                    config: { responseMimeType: "application/json" },
                });

                const links = parseJsonFromMarkdown(response.text);
                if (Array.isArray(links)) {
                    outputElement.innerHTML = links
                        .map(
                            (link) =>
                                `<a href="${link.url}" target="_blank" rel="noopener noreferrer">${link.title}</a>`
                        )
                        .join("");
                } else {
                    outputElement.innerText =
                        "Otrzymano nieprawidowy format danych.";
                }
            } catch (error) {
                console.error("AI Error:", error);
                outputElement.innerText = `Wystpi bd: ${error}`;
            } finally {
                loadingIndicator.style.display = "none";
            }
        });
}

function initAddonsModal() {
    document
        .getElementById("suggest-extension-button")
        ?.addEventListener("click", () => {
            const idea = document.getElementById("extension-idea-input").value;
            const prompt = `Rozwi ten pomys na rozszerzenie przegldarki: "${idea}". Opisz jego g贸wne funkcje, grup docelow i zaproponuj chwytliw nazw. Sformatuj odpowied藕 u偶ywajc nag贸wk贸w markdown.`;
            runAi(
                prompt,
                "ai-model-select-3",
                "loading-indicator-3",
                "extension-suggestion-output"
            );
        });
}

function initUiOptimizationModal() {
    document
        .getElementById("suggest-ui-optimization-button")
        ?.addEventListener("click", () => {
            const idea = document.getElementById("ui-optimization-input").value;
            const prompt = `Zaproponuj konkretne sugestie optymalizacji UI/UX dla nastpujcego problemu: "${idea}". Skup si na praktycznych, mo偶liwych do wdro偶enia zmianach.`;
            runAi(
                prompt,
                "ai-model-select-4",
                "loading-indicator-4",
                "ui-optimization-output"
            );
        });
}

async function initCardGeneratorModal() {
    document
        .getElementById("generate-card-content-button")
        ?.addEventListener("click", async () => {
            const topic = document.getElementById("card-topic-input").value;
            const loadingIndicator = document.getElementById(
                "loading-indicator-5"
            );
            const outputElement = document.getElementById(
                "card-generator-output"
            );

            const prompt = `Wygeneruj tre dla karty informacyjnej na temat "${topic}". Podaj kr贸tki, chwytliwy tytu (max 5 s贸w) i jednozdaniowy opis (max 20 s贸w). Zwr贸 jako obiekt JSON z kluczami "title" i "description".`;

            loadingIndicator.style.display = "block";
            outputElement.innerHTML = "";

            try {
                const response = await ai.models.generateContent({
                    model: "gemini-2.5-flash-preview-04-17",
                    contents: prompt,
                    config: { responseMimeType: "application/json" },
                });
                const card = parseJsonFromMarkdown(response.text);
                outputElement.innerHTML = `<h3>${card.title}</h3><p>${card.description}</p>`;
            } catch (error) {
                console.error("AI Error:", error);
                outputElement.innerText = `Wystpi bd: ${error}`;
            } finally {
                loadingIndicator.style.display = "none";
            }
        });
}

function initChatModal() {
    const sendButton = document.getElementById("send-chat-button");
    const chatInput = document.getElementById("chat-input");

    sendButton?.addEventListener("click", handleChatMessage);
    chatInput?.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            handleChatMessage();
        }
    });
}

async function handleChatMessage() {
    const chatInput = document.getElementById("chat-input");
    const messagesContainer = document.getElementById("chat-messages");
    const loadingIndicator = document.getElementById("loading-indicator-6");
    const modelSelect = document.getElementById("ai-model-select-6");

    const message = chatInput.value.trim();
    if (!message) return;

    // Display user message with improved formatting
    const userMessageDiv = document.createElement("div");
    userMessageDiv.className = "message user-message";
    userMessageDiv.innerHTML = escapeHtml(message).replace(/\n/g, "<br>");
    messagesContainer.appendChild(userMessageDiv);

    chatInput.value = "";
    messagesContainer.scrollTop = messagesContainer.scrollHeight;

    // Enhanced loading indicator
    loadingIndicator.style.display = "block";
    loadingIndicator.innerHTML =
        '<i class="fas fa-robot fa-spin"></i> AI myli...';

    try {
        // Use the enhanced runAi function for better error handling
        const tempOutputId = "temp-chat-output-" + Date.now();
        const tempDiv = document.createElement("div");
        tempDiv.id = tempOutputId;
        tempDiv.style.display = "none";
        document.body.appendChild(tempDiv);

        // Enhanced system instruction for chat
        const systemInstruction = `Jeste pomocnym asystentem AI. Odpowiadaj w jzyku polskim, chyba 偶e u偶ytkownik prosi o inny jzyk.
        Bd藕 przyjazny, konkretny i pomocny. Jeli nie znasz odpowiedzi, szczerze to przyznaj.
        Formatuj swoje odpowiedzi u偶ywajc markdown gdy to mo偶e pom贸c w czytelnoci.`;

        await runAi(
            message,
            "ai-model-select-6",
            "loading-indicator-6",
            tempOutputId,
            systemInstruction
        );

        // Transfer the response to chat
        const aiMessageDiv = document.createElement("div");
        aiMessageDiv.className = "message ai-message";
        aiMessageDiv.innerHTML =
            tempDiv.innerHTML || "Nie udao si wygenerowa odpowiedzi.";
        messagesContainer.appendChild(aiMessageDiv);

        // Clean up temp element
        tempDiv.remove();

        // Add message to chat history for context
        if (!window.chatHistory) window.chatHistory = [];
        window.chatHistory.push({
            role: "user",
            content: message,
        });
        window.chatHistory.push({
            role: "assistant",
            content: aiMessageDiv.textContent || aiMessageDiv.innerText,
        });

        // Keep only last 10 exchanges to manage context length
        if (window.chatHistory.length > 20) {
            window.chatHistory = window.chatHistory.slice(-20);
        }
    } catch (error) {
        console.error("Chat Error:", error);
        // Show error modal for chat errors
        showErrorModal(
            "Bd czatu",
            "Wystpi problem z poczeniem AI.",
            `Szczeg贸y: ${error.message}`
        );
    } finally {
        loadingIndicator.style.display = "none";
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
}

// Helper function to escape HTML
function escapeHtml(text) {
    const map = {
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#039;",
    };
    return text.replace(/[&<>"']/g, function (m) {
        return map[m];
    });
}

async function initCodeGeneratorModal() {
    document
        .getElementById("generate-code-button")
        ?.addEventListener("click", async () => {
            const description = document.getElementById(
                "code-description-input"
            ).value;
            if (!description.trim()) {
                showErrorModal(
                    "Bd walidacji",
                    "Prosz podaj opis kodu do wygenerowania."
                );
                return;
            }

            const systemInstruction = `Jeste ekspertem programist. Generuj czysty, dobrze skomentowany kod zgodnie z najlepszymi praktykami.
        
        Zasady:
        1. Zawsze umieszczaj kod w bloku markdown z okrelonym jzykiem
        2. Dodaj komentarze wyjaniajce kluczowe czci
        3. U偶yj opisowych nazw zmiennych
        4. Podaj przykad u偶ycia jeli to mo偶liwe
        5. Zasugeruj dodatkowe ulepszenia jeli to pomocne`;

            const enhancedPrompt = `Wygeneruj fragment kodu dla: "${description}".

        Struktura odpowiedzi:
        - Kr贸tkie wyjanienie co robi kod
        - G贸wny kod w odpowiednim bloku markdown
        - Przykad u偶ycia (jeli dotyczy)
        - Opcjonalne sugestie rozszerze`;

            runAi(
                enhancedPrompt,
                "ai-model-select-7",
                "loading-indicator-7",
                "code-generator-output",
                systemInstruction
            );
        });

    // Dodaj obsug Enter w polu input
    document
        .getElementById("code-description-input")
        ?.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                document.getElementById("generate-code-button")?.click();
            }
        });

    // Dodaj predefiniowane przykady
    addCodeExamples();
}

function addCodeExamples() {
    const examplesContainer = document.getElementById(
        "code-examples-container"
    );
    if (!examplesContainer) return;

    const examples = [
        {
            title: " Formularz kontaktowy",
            description: "formularz kontaktowy HTML z walidacj JavaScript",
        },
        {
            title: " Gra w k贸ko i krzy偶yk",
            description: "prosta gra w k贸ko i krzy偶yk w JavaScript",
        },
        {
            title: " Wykres danych",
            description:
                "wykres supkowy z danymi sprzeda偶y w Python matplotlib",
        },
        {
            title: " System logowania",
            description: "bezpieczny system logowania w PHP z haszowaniem",
        },
        {
            title: " Responsywne menu",
            description: "responsywne menu nawigacyjne CSS z animacjami",
        },
    ];

    examples.forEach((example) => {
        const button = document.createElement("button");
        button.className = "example-button";
        button.innerHTML = `<span>${example.title}</span>`;
        button.onclick = () => {
            document.getElementById("code-description-input").value =
                example.description;
        };
        examplesContainer.appendChild(button);
    });
}

function initTranslatorModal() {
    document
        .getElementById("translate-text-button")
        ?.addEventListener("click", () => {
            const text = document.getElementById("translation-input").value;
            const lang = document.getElementById(
                "target-language-select"
            ).value;
            const prompt = `Przetumacz poni偶szy tekst na jzyk ${lang}. Zwr贸 tylko przetumaczony tekst, bez 偶adnych dodatkowych wyjanie.\n\nTekst: "${text}"`;
            runAi(
                prompt,
                "ai-model-select-8",
                "loading-indicator-8",
                "translation-output-display"
            );
        });
}

function initTextAnalyzerModal() {
    document
        .getElementById("analyze-text-button")
        ?.addEventListener("click", () => {
            const text = document.getElementById("text-analysis-input").value;
            if (!text.trim()) {
                showErrorModal(
                    "Bd walidacji",
                    "Prosz wklej tekst do analizy."
                );
                return;
            }

            // Collect selected analysis options
            const options = [];
            if (document.getElementById("sentiment-analysis").checked)
                options.push("sentiment");
            if (document.getElementById("tone-analysis").checked)
                options.push("tone");
            if (document.getElementById("readability-analysis").checked)
                options.push("readability");
            if (document.getElementById("keyword-analysis").checked)
                options.push("keywords");
            if (document.getElementById("summary-analysis").checked)
                options.push("summary");
            if (document.getElementById("improvement-suggestions").checked)
                options.push("improvements");

            if (options.length === 0) {
                showErrorModal(
                    "Bd walidacji",
                    "Prosz wybierz przynajmniej jedn opcj analizy."
                );
                return;
            }

            const systemInstruction = `Jeste ekspertem w analizie tekstu i jzykoznawstwie. Przeprowad藕 dokadn analiz podanego tekstu.
        
        Formatuj odpowied藕 w HTML u偶ywajc:
        - <div class="analysis-section"> dla ka偶dej sekcji analizy
        - <h4> dla nag贸wk贸w sekcji z odpowiednimi ikonami
        - <div class="analysis-result"> dla wynik贸w
        - Klasy CSS: sentiment-positive, sentiment-negative, sentiment-neutral dla sentymentu
        - Klasy CSS: readability-easy, readability-medium, readability-hard dla trudnoci czytania
        
        Bd藕 konkretny i podaj praktyczne uwagi.`;

            let analysisTypes = {
                sentiment: "Analiza sentymentu (pozytywny/negatywny/neutralny)",
                tone: "Analiza tonu (formalny/nieformalny, profesjonalny/casual, etc.)",
                readability: "Analiza trudnoci czytania (atwy/redni/trudny)",
                keywords: "Identyfikacja s贸w kluczowych i temat贸w",
                summary: "Kr贸tkie streszczenie tekstu",
                improvements: "Sugestie poprawek stylistycznych i jzykowych",
            };

            const selectedAnalyses = options
                .map((opt) => analysisTypes[opt])
                .join(", ");

            const prompt = `Przeanalizuj poni偶szy tekst pod ktem: ${selectedAnalyses}

TEKST DO ANALIZY:
"${text}"

Przeprowad藕 szczeg贸ow analiz i przedstaw wyniki w przejrzysty spos贸b z u偶yciem HTML i odpowiednich klas CSS.`;

            runAi(
                prompt,
                "ai-model-select-10",
                "loading-indicator-10",
                "text-analysis-output",
                systemInstruction
            );
        });

    // Add Enter key support for text area
    document
        .getElementById("text-analysis-input")
        ?.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && e.ctrlKey) {
                e.preventDefault();
                document.getElementById("analyze-text-button")?.click();
            }
        });

    // Add quick text examples
    addTextAnalysisExamples();
}

function addTextAnalysisExamples() {
    const textInput = document.getElementById("text-analysis-input");
    if (!textInput) return;

    const examples = [
        {
            title: " Tekst formalny",
            text: "Zgodnie z przedstawionymi danymi, wzrost gospodarczy w ostatnim kwartale wyni贸s 3.2%, co stanowi znaczcy postp w por贸wnaniu do analogicznego okresu roku poprzedniego. Eksperci przewiduj dalszy wzrost w nadchodzcych miesicach.",
        },
        {
            title: " Tekst nieformalny",
            text: "Hej! Sprawdziem wczoraj ten nowy film i musz przyzna, 偶e totalnie mnie rozczarowa. Spodziewaem si czego lepszego, ale w kocu nie da si wszystkim dogodzia, prawda? ",
        },
        {
            title: " Email biznesowy",
            text: "Szanowni Pastwo, w nawizaniu do naszej wczorajszej rozmowy telefonicznej, przesyam w zaczeniu dokumenty niezbdne do finalizacji umowy. Prosimy o sprawdzenie i przesanie podpisanych egzemplarzy do koca tygodnia.",
        },
    ];

    // Add example buttons after the textarea
    const examplesDiv = document.createElement("div");
    examplesDiv.className = "text-examples";
    examplesDiv.innerHTML = "<p><strong>Przykady tekst贸w:</strong></p>";

    examples.forEach((example) => {
        const button = document.createElement("button");
        button.className = "example-button";
        button.textContent = example.title;
        button.style.margin = "4px";
        button.onclick = () => {
            textInput.value = example.text;
        };
        examplesDiv.appendChild(button);
    });

    textInput.parentNode.insertBefore(examplesDiv, textInput.nextSibling);
}

function initCardIframeLinks() {
    const contentContainer = document.querySelector(".content-container");
    const modal = document.getElementById("myModal9");
    const urlInput = document.getElementById("iframe-url-input");
    const loadButton = document.getElementById("load-iframe-button");
    const newTabButton = document.getElementById("open-in-new-tab-button");

    if (
        !contentContainer ||
        !modal ||
        !urlInput ||
        !loadButton ||
        !newTabButton
    )
        return;

    contentContainer.addEventListener("click", (e) => {
        const target = e.target;
        const link = target.closest(".card-iframe-link");

        if (link && link.matches("a")) {
            e.preventDefault();
            const url = link.getAttribute("href");
            if (url) {
                urlInput.value = url;
                newTabButton.href = url;
                modal.classList.add("active");
                loadButton.click();
            }
        }
    });
}

function initIframeViewerModal() {
    const modal = document.getElementById("myModal9");
    const loadButton = document.getElementById("load-iframe-button");
    const urlInput = document.getElementById("iframe-url-input");
    const iframe = document.getElementById("content-iframe");
    const loadingIndicator = document.getElementById(
        "iframe-loading-indicator"
    );
    const newTabButton = document.getElementById("open-in-new-tab-button");
    const refreshButton = document.getElementById("refresh-iframe-button");
    const closeButton = document.getElementById("close-iframe-button");

    if (
        !modal ||
        !loadButton ||
        !urlInput ||
        !iframe ||
        !loadingIndicator ||
        !newTabButton ||
        !refreshButton ||
        !closeButton
    )
        return;

    const loadUrl = () => {
        const url = urlInput.value.trim();
        if (url) {
            let fullUrl = url;
            if (!/^https?:\/\//i.test(url)) {
                fullUrl = "https://" + url;
                urlInput.value = fullUrl;
            }
            loadingIndicator.style.display = "block";
            iframe.style.visibility = "hidden";
            iframe.src = fullUrl;
            newTabButton.href = fullUrl;
        } else {
            showErrorModal("Bd walidacji", "Prosz wprowadzi URL.");
        }
    };

    loadButton.addEventListener("click", loadUrl);
    urlInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
            e.preventDefault();
            loadUrl();
        }
    });

    iframe.addEventListener("load", () => {
        loadingIndicator.style.display = "none";
        iframe.style.visibility = "visible";
    });

    iframe.addEventListener("error", () => {
        loadingIndicator.style.display = "none";
        iframe.style.visibility = "visible";
        showErrorModal(
            "Bd adowania",
            "Nie udao si zaadowa podanego adresu URL.",
            "Strona mo偶e blokowa osadzanie (X-Frame-Options) lub wystpi inny bd."
        );
    });

    refreshButton.addEventListener("click", () => {
        if (iframe.src && iframe.src !== "about:blank") {
            iframe.contentWindow?.location.reload();
        }
    });

    closeButton.addEventListener("click", () => {
        modal.classList.remove("active");
        iframe.src = "about:blank";
        urlInput.value = "";
        newTabButton.href = "#";
    });
}

// Function to show error modal with auto-close functionality
function showErrorModal(title, message, details = "") {
    // Remove existing error modal if present
    const existingModal = document.getElementById("error-modal");
    if (existingModal) {
        existingModal.remove();
    }

    // Create error modal
    const errorModal = document.createElement("div");
    errorModal.id = "error-modal";
    errorModal.className = "error-modal";

    errorModal.innerHTML = `
        <div class="error-message">
            <button class="error-close-btn" onclick="closeErrorModal()">&times;</button>
            <i class="fas fa-exclamation-triangle"></i>
            <strong>${title}</strong>
            ${message}
            ${details ? `<small>${details}</small>` : ""}
            <div class="error-progress"></div>
        </div>
    `;

    document.body.appendChild(errorModal);

    // Show modal with animation
    setTimeout(() => {
        errorModal.classList.add("show");
    }, 10);

    // Auto close after 5 seconds
    setTimeout(() => {
        closeErrorModal();
    }, 5000);

    // Close on click outside
    errorModal.addEventListener("click", (e) => {
        if (e.target === errorModal) {
            closeErrorModal();
        }
    });

    // Close on Escape key
    const handleEscape = (e) => {
        if (e.key === "Escape") {
            closeErrorModal();
            document.removeEventListener("keydown", handleEscape);
        }
    };
    document.addEventListener("keydown", handleEscape);
}

// Function to close error modal
function closeErrorModal() {
    const errorModal = document.getElementById("error-modal");
    if (errorModal) {
        errorModal.classList.remove("show");
        setTimeout(() => {
            errorModal.remove();
        }, 300);
    }
}


